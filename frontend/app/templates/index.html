<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
    <title>{% block title %}Frontend{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
          integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
          crossorigin="anonymous">

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin="anonymous">

    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    {% endblock %}
</head>
<body>
    {% block body %}
    <nav class="navbar navbar-expand-md navbar-reverse navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Ashlar Public Frontend</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbar-content" aria-controls="navbar-content"
                    aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbar-content">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown"
                           role="button" aria-haspopup="true" aria-expanded="false"
                           id="recordtype-dropdown-link">
                            Record Types
                        </a>
                        <div class="dropdown-menu" id="recordtype-dropdown"
                             aria-labelledby="recordtype-dropdown-link"></div>
                    </li>
                </ul>
                <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Filter by search" aria-label="Filter by search">
                    <button class="btn btn-outline-dark my-2 my-sm-0" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div id="map"></div>
        </div>
    </div>
    {% endblock %}

    <!-- Load Babel polyfill for ES6 support -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>

    <!-- Load Popper (Bootstrap dependency) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
            integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
            crossorigin="anonymous"></script>

    <!-- Load Bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
            integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
            crossorigin="anonymous"></script>

    <!-- Load Leaflet -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin="anonymous"></script>

    <!-- Extra JS files -->
    {% block extra_js %}
    <script type="text/babel">
        $(() => {
            // Global state
            var layerCache = new Map();  // Cache marker layers storing Records by RecordType
            var activeLayer = {};  // Currently-selected marker layer

            // Make map fullscreen
            $(window).resize(() => {
                let windowHeight = $(window).outerHeight();
                let offsetTop = $('.navbar').height(); // Calculate the top offset

                let mapHeight = windowHeight - offsetTop;
                $('#map').css('height', mapHeight);
            }).resize();

            // Initialize a map
            var map = new L.map('map', {
                center: [39.95, -75.16],
                zoom: 12,
                dragging: true,
                touchZoom: true,
                tap: true,
                scrollWheelZoom: false
            });

            // Add tile layer from OSM
            var tiles = new L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> Contributors',
                maxZoom: 18,
            }).addTo(map);

            // URL for retrieving data from the Ashlar instance
            const apiUrl = 'http://127.0.0.1:8000/api';

            // Retrieve record types from the API to populate filters
            $.getJSON(`${apiUrl}/recordtypes/`)
                .done((data) => {
                    let recordtypes = data.results;

                    // Create navbar filters for each record type
                    for (let recordtype of recordtypes) {
                        // Add a filter for this RecordType to the navbar
                        let navItem = `
                            <a class="dropdown-item filter-recordtype"
                               id="${recordtype.uuid}"
                               data-schema="${recordtype.current_schema}"
                               href="#">
                                ${recordtype.plural_label}
                            </a>
                        `;
                        $('#recordtype-dropdown').append(navItem);
                    }

                    // Allow user to toggle layers from the navbar
                    $('.filter-recordtype').click(function(e) {
                        e.preventDefault();

                        const recordTypeId = $(this).attr('id');
                        const currentSchemaId = $(this).attr('data-schema');

                        // Update filters for the current selection
                        updateFilters(currentSchemaId);

                        // If a layer is currently active, remove it from the map
                        if (Object.keys(activeLayer).length !== 0 && map.hasLayer(activeLayer)) {
                            map.removeLayer(activeLayer);
                        }

                        // Prefer layers in the cache
                        let layer = layerCache[recordTypeId];
                        if (typeof(layer) !== 'undefined') {
                            map.addLayer(layer);
                            activeLayer = layer;
                        } else {
                            // Layer is not in the cache -- retrieve the records from the API
                            let queryParams = {
                                archived: false,
                                record_type: recordTypeId
                            };
                            $.getJSON(`${apiUrl}/records/`, data=queryParams)
                                .done((data) => {
                                    let records = data.results;
                                    let markers = [];
                                    if (records) {
                                        for (let record of records) {
                                            // Extract data for display as a marker
                                            let coords = record.geom.coordinates;
                                            let lat = coords[0],
                                                lng = coords[1];

                                            let details = JSON.stringify({
                                                start: record.occurred_from,
                                                end: record.occurred_to,
                                                data: record.data,
                                            }, null, 2);

                                            let popup = `
                                                <h3>Details</h3>
                                                <hr/>
                                                <pre>
                                                    <code>
                                                        ${details}
                                                    </code>
                                                </pre>
                                            `;

                                            // Store the marker in a layer so that users
                                            // can toggle it with the navbar and we
                                            // can cache it
                                            markers.push(new L.marker([lng, lat])
                                                                .bindPopup(popup));
                                        }
                                        // Cache this layer
                                        layer = new L.layerGroup(markers);
                                        layerCache.set(recordTypeId, layer);

                                        // Add the layer to the map
                                        map.addLayer(layer);
                                        activeLayer = layer;
                                    } else {
                                        alert(`No records found for RecordType "${recordTypeId}"`);
                                    }
                              }).fail((err) => {
                                    alert(err);
                              });
                        }
                    });
                    // Once the navbar is prepared, select the first layer for display
                    map.whenReady(() => {
                        $('.filter-recordtype').first().click();
                    });
              }).fail((err) => {
                    alert(err);
              });

            // Load filters
            function updateFilters(schemaId) {
                // Clear existing filters
                $('.filterable').remove();

                // Retrieve the schema to figure out what fields need to be displayed
                $.getJSON(`${apiUrl}/recordschemas/${schemaId}`)
                    .done((schema) => {
                        let definitions = {};
                        if (schema.schema && schema.schema.definitions) {
                            definitions = schema.schema.definitions;
                        }

                        let isFilterable = function(val) { return val.isSearchable; };
                        let filterables = {};
                        Object.keys(definitions).forEach((key) => {
                            let schema = definitions[key];
                            Object.keys(schema.properties).forEach((prop) => {
                                let property = schema.properties[prop];
                                // merge in `multiple` to keep track of the type of containment
                                if (isFilterable(property)) {
                                    filterables[prop] = Object.assign({}, property, {multiple: schema.multiple});
                                }
                            });
                        });

                        Object.keys(filterables).forEach((key) => {
                            let filterable = filterables[key];
                            let elem = `
                                <ul class="navbar-nav filterable">
                                    <li class="nav-item dropdown">
                                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown"
                                        role="button" aria-haspopup="true" aria-expanded="false">
                                            ${key}
                                        </a>
                                        <div class="dropdown-menu">
                            `;

                            if (filterable.fieldType === 'number') {
                                // Number types should produce range dropdowns
                                elem += `
                                            <div class="form-group">
                                                <label for="min">From</label>
                                                <input name="min" placeholder="minimum" />
                                                <label for="max">To</label>
                                                <input name="max" placeholder="maximum" />
                                            </div>
                                `

                            } else if (filterable.fieldType === 'selectlist') {
                                // Select list types need to provide options for
                                // selection
                                elem += `
                                            <div class="form-group">
                                                <select class="selectpicker form-control"
                                                        multiple>
                                `;

                                for (let opt of filterable.enum) {
                                    elem += `
                                                    <option value="${opt}">${opt}</option>
                                    `;
                                }

                                elem += `
                                                </select>
                                            </div>
                                `;

                            } else {
                                // No other types need elements, so break.
                                return;
                            }

                            elem += `
                                        </div>
                                    </li>
                                </ul>
                            `;

                            $('#navbar-content').append(elem);
                        });
                  }).fail((err) => {
                        console.log(err);
                  });
            }

        });

    </script>
    {% endblock %}
</body>

</html>
